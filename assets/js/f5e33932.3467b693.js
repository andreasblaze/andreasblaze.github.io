"use strict";(self.webpackChunktech_notes=self.webpackChunktech_notes||[]).push([[3555],{1134:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>r});const a=JSON.parse('{"id":"scripting/clamav_scan","title":"ClamAV Scan to Flock Notification","description":"","source":"@site/docs/scripting/clamav_scan.md","sourceDirName":"scripting","slug":"/scripting/clamav_scan","permalink":"/scripting/clamav_scan","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"GET Grafana Users","permalink":"/scripting/GetGrafanaUsers"},"next":{"title":"pd_flock_server","permalink":"/scripting/pd_flock_server"}}');var c=t(4848),s=t(8453);const i={},o="ClamAV Scan to Flock Notification",l={},r=[];function m(n){const e={code:"code",h1:"h1",header:"header",pre:"pre",...(0,s.R)(),...n.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(e.header,{children:(0,c.jsx)(e.h1,{id:"clamav-scan-to-flock-notification",children:"ClamAV Scan to Flock Notification"})}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-shell",metastring:'title="clamav_scan" showLineNumbers',children:'#!/bin/bash\n\n# === Configuration ===\nFLOCK_TOKEN="TOKEN"\nFLOCK_URL="https://api.flock.com/hooks/sendMessage/${FLOCK_TOKEN}"\n\nCLAMAV_DB_URLS=(\n  "https://signature-rule-distribution.com/example/clamav_custom.hdb"\n  "https://signature-rule-distribution.com/example/clamav_custom.yar"\n  "https://signature-rule-distribution.com/example/clamav_custom.ndb"\n)\n\nDB_PATH="/var/lib/clamav"\nLOG_PATH="/var/log/clamav"\nLOG_NAME="$(date -Im)_clamscan.log"\n\nmkdir -p "${DB_PATH}" "${LOG_PATH}"\n\n# === Pre-checks ===\nif [[ "${FLOCK_TOKEN}" == "change-me" || -z "${FLOCK_TOKEN}" ]]; then\n    echo "FLOCK_TOKEN is not set, exiting."\n    exit 1\nfi\n\n# === comment this if Docker used ===\n# if ! command -v clamscan > /dev/null; then\n#     echo "\'clamscan\' is required but not installed."\n#     exit 1\n# fi\n\n# === Clean previous logs ===\nrm -f "${LOG_PATH}"/*.log\n\n# === Download ClamAV DB files ===\ncd "${DB_PATH}" || exit 1\nfor url in "${CLAMAV_DB_URLS[@]}"; do\n    echo "Downloading ${url}"\n    curl --max-time 120 -L "${url}" -O || exit 1\ndone\n\n# === Run ClamAV Scan ===\n# echo "Running clamscan... this may take a while"\n# clamscan --infected  --cross-fs=yes --database=${DB_PATH} \\\n# \t\t --recursive=yes --allmatch=no  --log=${LOG_PATH}/${log_name} \\\n# \t\t --exclude-dir="/var/lib/clamav/|/data*/|/var/lib/mysql/"  /\n\n# === Run Dockerized ClamAV Scan ===\necho "Running Dockerized clamscan..."\n\ndocker run --rm \\\n  -v "/:/scan:ro" \\\n  -v "${DB_PATH}:/var/lib/clamav" \\\n  -v "${LOG_PATH}:/logs" \\\n  clamav/clamav:stable \\\n  clamscan --infected --cross-fs=yes --recursive=yes --allmatch=no \\\n           --log=/logs/${LOG_NAME} --exclude-dir="^/var/lib/clamav/|^/data.*/|^/var/lib/mysql/|^/scan/usr/lib/clamav-signatures/" /scan\n\nCLAMSCAN_EXIT_CODE=$?\n\n# === Handle Results ===\nif [[ ${CLAMSCAN_EXIT_CODE} -eq 0 ]]; then\n    echo "All clean, no viruses found. Exiting."\n    exit 0\nfi\n\n# Extract summary\nSUMMARY=$(sed -n \'/SCAN SUMMARY/,$p\' "${LOG_PATH}/${LOG_NAME}" | sed -z \'s/\\n/<br>/g\')\nHOST=$(hostname)\n\nif grep -q \'Infected files: 0\' "${LOG_PATH}/${LOG_NAME}"; then\n    echo "No infected files, exiting."\n    exit 0\nfi\n\n# === Send Notification to Flock ===\necho "Infected files found! Sending to Flock..."\n\ncurl -X POST "${FLOCK_URL}" \\\n     -H "Content-Type: application/json" \\\n     -d "{\\"flockml\\": \\"<flockml>ClamAV scan results for: <b>${HOST}</b><br>Date: $(date -Im)<br>Results:<br>${SUMMARY}</flockml>\\"}"\n'})})]})}function d(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,c.jsx)(e,{...n,children:(0,c.jsx)(m,{...n})}):m(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>o});var a=t(6540);const c={},s=a.createContext(c);function i(n){const e=a.useContext(s);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(c):n.components||c:i(n.components),a.createElement(s.Provider,{value:e},n.children)}}}]);